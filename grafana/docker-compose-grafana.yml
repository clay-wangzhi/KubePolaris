services:
  grafana:
    image: grafana/grafana:10.2.0
    container_name: kubepolaris-grafana
    ports:
      - "3000:3000"
    environment:
      # ç®¡ç†å‘˜è´¦å·
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      
      # å…³é”®ï¼šå…è®¸ iframe åµŒå…¥
      - GF_SECURITY_ALLOW_EMBEDDING=true
      
      # Cookie è®¾ç½®
      - GF_SECURITY_COOKIE_SAMESITE=lax
      - GF_SECURITY_COOKIE_SECURE=false
      
      # åŒ¿åè®¿é—® - Viewer è§’è‰²ï¼ˆå®‰å…¨ï¼‰
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_AUTH_ANONYMOUS_ORG_NAME=Main Org.
      
      # ç¦ç”¨æ³¨å†Œ
      - GF_USERS_ALLOW_SIGN_UP=false
      
      # æ—¥å¿—çº§åˆ«
      - GF_LOG_LEVEL=info
    volumes:
      - grafana_data:/var/lib/grafana
      - ./provisioning:/etc/grafana/provisioning
      - ./dashboards:/var/lib/grafana/dashboards
    restart: unless-stopped
    networks:
      - kubepolaris-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # åˆå§‹åŒ–å®¹å™¨ï¼šè®¾ç½®æƒé™ + è‡ªåŠ¨ç”Ÿæˆ API Key
  grafana-init:
    image: curlimages/curl:latest
    container_name: kubepolaris-grafana-init
    depends_on:
      grafana:
        condition: service_healthy
    environment:
      - GRAFANA_URL=http://grafana:3000
      - GRAFANA_USER=admin
      - GRAFANA_PASSWORD=admin123
    volumes:
      - ./secrets:/secrets
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "â³ ç­‰å¾… Dashboard åŠ è½½å®Œæˆ..."
        sleep 5
        
        echo "ğŸ”§ è®¾ç½® KubePolaris æ–‡ä»¶å¤¹æƒé™..."
        curl -s -X POST \
          -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          -H "Content-Type: application/json" \
          -d '{"items":[{"role":"Viewer","permission":1},{"role":"Editor","permission":2}]}' \
          "$${GRAFANA_URL}/api/folders/kubepolaris-folder/permissions"
        echo " âœ… æƒé™è®¾ç½®å®Œæˆ"
        
        echo ""
        echo "ğŸ”‘ åˆ›å»º Service Account å’Œ API Token..."
        
        # æ£€æŸ¥ Service Account æ˜¯å¦å·²å­˜åœ¨
        SA_EXISTS=$$(curl -s -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          "$${GRAFANA_URL}/api/serviceaccounts/search?query=kubepolaris" | grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)
        
        if [ -z "$$SA_EXISTS" ]; then
          echo "  ğŸ“ åˆ›å»ºæ–°çš„ Service Account..."
          SA_RESULT=$$(curl -s -X POST \
            -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
            -H "Content-Type: application/json" \
            -d '{"name":"kubepolaris","role":"Admin","isDisabled":false}' \
            "$${GRAFANA_URL}/api/serviceaccounts")
          SA_ID=$$(echo "$$SA_RESULT" | grep -o '"id":[0-9]*' | cut -d: -f2)
          echo "  âœ… Service Account åˆ›å»ºæˆåŠŸï¼ŒID: $$SA_ID"
        else
          SA_ID=$$SA_EXISTS
          echo "  â„¹ï¸  Service Account å·²å­˜åœ¨ï¼ŒID: $$SA_ID"
        fi
        
        # åˆ é™¤æ—§çš„ Tokenï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        curl -s -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens" | \
          grep -o '"id":[0-9]*' | cut -d: -f2 | while read TOKEN_ID; do
            curl -s -X DELETE \
              -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
              "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens/$$TOKEN_ID"
          done
        
        # åˆ›å»ºæ–°çš„ Token
        echo "  ğŸ” ç”Ÿæˆæ–°çš„ API Token..."
        TOKEN_RESULT=$$(curl -s -X POST \
          -u "$${GRAFANA_USER}:$${GRAFANA_PASSWORD}" \
          -H "Content-Type: application/json" \
          -d '{"name":"kubepolaris-token","secondsToLive":0}' \
          "$${GRAFANA_URL}/api/serviceaccounts/$$SA_ID/tokens")
        
        API_KEY=$$(echo "$$TOKEN_RESULT" | grep -o '"key":"[^"]*"' | cut -d'"' -f4)
        
        if [ -n "$$API_KEY" ]; then
          echo "$$API_KEY" > /secrets/grafana_api_key
          echo "  âœ… API Token å·²ä¿å­˜åˆ° /secrets/grafana_api_key"
          echo ""
          echo "=========================================="
          echo "ğŸ‰ Grafana åˆå§‹åŒ–å®Œæˆï¼"
          echo "=========================================="
          echo "API Key: $$API_KEY"
          echo ""
          echo "è¯·å°†æ­¤ API Key é…ç½®åˆ° configs/config.yaml:"
          echo "  grafana:"
          echo "    api_key: \"$$API_KEY\""
          echo "=========================================="
        else
          echo "  âŒ Token åˆ›å»ºå¤±è´¥: $$TOKEN_RESULT"
          exit 1
        fi
    networks:
      - kubepolaris-network
    restart: "no"

volumes:
  grafana_data:

networks:
  kubepolaris-network:
    driver: bridge
